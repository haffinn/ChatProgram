/*
 chatserver 2015-02-26 
*/


var ChatClient=angular.module("ChatClient",["ngRoute"]);

ChatClient.config(function(a){
	a.when("/login",{
	templateUrl:"src/Views/login.html",controller:"LoginController"}).when("/rooms/:user/",{
	templateUrl:"src/Views/rooms.html",controller:"RoomsController"}).when("/room/:user/:room/",{
	templateUrl:"src/Views/room.html",controller:"RoomController"}).otherwise({
		redirectTo:"login"});}),ChatClient.controller("LoginController",function(a,b,c,d,e){
	a.errorMessage="",a.nickname="",a.login=function(){
	""===a.nickname?a.errorMessage="Please choose a nick-name before continuing!":e.emit("adduser",a.nickname,function(c){
	c?b.path("/rooms/"+a.nickname):a.errorMessage="This nick-name is already taken!"})}}),ChatClient.controller("RoomsController",function(a,b,c,d,e){
	a.rooms=[],a.currentUser=d.user,a.roomname="",a.message="",a.users=[],a.prvtMessages=[],a.prvtMessage="",a.prvtMessageTo="",a.submitPrvtMsg=function(){
	""!==a.prvtMessage&&e.emit("privatemsg",{
	nick:a.prvtMessageTo,message:a.prvtMessage,from:a.currentUser},function(b){
	if(b){
	a.prvtMessages.push({
	nick:a.currentUser,message:a.prvtMessage}),a.prvtMessage="";
var c=$(".prvt-chat-content")[0].scrollHeight;
$(".prvt-chat-content").scrollTop(c)}else a.errorMessage="This user does not exist!"})},a.joinARoom=function(c){
	console.log("Join a room called. Room requested is %"+c+"%"),e.emit("joinroom",{
	room:c},function(d,e){
	"banned"===e&&(a.errorMessage="Join failed - You are banned!",console.log("Join failed - You are banned!")),d?b.path("/room/"+a.currentUser+"/"+c):(a.errorMessage=e,console.log(e))})},e.on("recv_privatemsg",function(b,c){
	a.prvtMessages.push({
	nick:b,message:c}),console.log("You got a message from:"),console.log(b),console.log("msg: "),console.log(c);
var d=$(".prvt-chat-content")[0].scrollHeight;
$(".prvt-chat-content").scrollTop(d)}),e.emit("users"),e.on("userlist",function(b){
	a.users=b}),a.newRoom=function(){
	""===a.roomname?a.errorMessage="Please enter a name for the new room":(a.rooms.push(a.roomname),e.emit("joinroom",{
	room:a.roomname},function(c,d){
	c?b.path("/room/"+a.currentUser+"/"+a.roomname):a.errorMessage=d}))},e.emit("rooms"),e.on("roomlist",function(b){
	a.rooms=Object.keys(b)}),a.discon=function(){
	e.emit("logout"),b.path("/login")}}),ChatClient.controller("RoomController",function(a,b,c,d,e){
	a.currentRoom=d.room,a.currentUser=d.user,a.currentUsers=[],a.opperators=[],a.errorMessage="",a.successMessage="",a.message="",a.messages=[],a.userToKickBanOp="",a.banList=[],a.userToUnban="",a.submitMsg=function(){
	""!==a.message&&(e.emit("sendmsg",{
	roomName:a.currentRoom,msg:a.message}),a.message="")},a.goBack=function(){
	e.emit("partroom",a.currentRoom),b.path("/rooms/"+a.currentUser)},a.discon=function(){
	e.emit("logout"),b.path("/login")},a.kickUser=function(){
	e.emit("kick",{
	user:a.userToKickBanOp,room:a.currentRoom},function(b){
	b?(a.successMessage="Succeccfully kicked user"+a.userToKickBanOp,console.log("Succeccfully kicked user: "+a.userToKickBanOp)):(a.errorMessage="Failed to kick user",console.log("Failed to kick user: "+a.userToKickBanOp))})},a.banUser=function(){
	e.emit("ban",{
	user:a.userToKickBanOp,room:a.currentRoom},function(b){
	b?(a.successMessage="Successfully banned user "+a.userToKickBanOp,console.log("Successfully banned user: "+a.userToKickBanOp)):(a.errorMessage="Failed to ban user "+a.userToKickBanOp,console.log("Failed to ban user: "+a.userToKickBanOp))})},a.unBanUser=function(){
	e.emit("unban",{
	user:a.userToUnban,room:a.currentRoom},function(b){
	b?a.successMessage="Successfully unbanned "+a.userToUnban:a.errorMessage="Failed to ban user "+a.userToUnban,a.userToUnban=""})},a.opUser=function(){
	e.emit("op",{
	user:a.userToKickBanOp,room:a.currentRoom},function(b){
	b?(a.successMessage="Successfully made "+a.userToKickBanOp+" admin",console.log("Successfully made "+a.userToKickBanOp+" admin")):(a.errorMessage="Failed to make "+a.userToKickBanOp+" admin",console.log("Failed to make "+a.userToKickBanOp+" admin"))})},a.deOpUser=function(){
	e.emit("deop",{
	user:a.userToKickBanOp,room:a.currentRoom},function(b){
	b?a.successMessage="Successfully revoked admin for "+a.userToKickBanOp:a.errorMessage="Failed to revoke admin for "+a.userToKickBanOp})},e.on("kicked",function(c,d){
	d===a.currentUser?(b.path("/rooms/"+a.currentUser),a.errorMessage="You have been kicked from "+a.currentRoom,console.log("You have been kicked from "+a.currentRoom)):c===a.currentRoom&&(a.successMessage=d+" has been kicked from "+c,console.log(d+" has been kicked from "+c))}),e.on("banned",function(c,d){
	d===a.currentUser?(b.path("/rooms/"+a.currentUser),a.errorMessage="You have been banned from "+a.currentRoom,console.log("You have been banned from "+a.currentRoom)):c===a.currentRoom&&(a.successMessage=d+" has been banned from "+c,console.log(d+" has been banned from "+c))}),e.on("updateusers",function(b,c,d){
	if(b===a.currentRoom){
	console.log("opperators:");
var e=[];
for(var f in d)e.push(f);
console.log(e),a.currentUsers=c,a.opperators=d}}),e.emit("joinroom",{
	room:a.currentRoom},function(b,c){
	b||(a.errorMessage=c)}),e.on("updatechat",function(b,c){
	if(a.currentRoom===b){
	a.messages=c;
var d=$(".chat-content")[0].scrollHeight;
$(".chat-content").scrollTop(d)}}),a.submitMsg=function(){
	""!==a.message&&(e.emit("sendmsg",{
	roomName:a.currentRoom,msg:a.message}),a.message="")}});
